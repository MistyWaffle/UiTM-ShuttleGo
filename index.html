<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UiTM ShuttleGo - Mobile App Prototype</title>
    <!-- 
        UiTM ShuttleGo V2.1
        -------------------
        Updates:
        - Added Dark Mode support.
        - Preserved Developer Credits.
        - Fixed minor visual bugs in dark mode map rendering.
    -->
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            /* Light Mode Defaults */
            --uitm-purple: #60269E;
            --uitm-green: #006837;
            --uitm-gold: #FFD100;
            --bg-neutral: #F2F4F6;
            --surface: #ffffff;
            --text-dark: #1a1a1a;
            --text-sub: #666666;
            --nav-bg: rgba(255, 255, 255, 0.95);
            --map-bg: #f4f9f6;
            --map-campus: #ffffff;
            --map-stroke: #e0e0e0;

            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-float: 0 8px 24px rgba(0, 0, 0, 0.12);
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] {
            --bg-neutral: #121212;
            --surface: #1e1e1e;
            --text-dark: #e0e0e0;
            --text-sub: #a0a0a0;
            --nav-bg: rgba(30, 30, 30, 0.95);
            --map-bg: #1a1a1a;
            --map-campus: #2a2a2a;
            --map-stroke: #444;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-float: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-neutral);
            color: var(--text-dark);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
            /* App-like feel */
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- HEADER --- */
        header {
            background: var(--surface);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 50;
            transition: background 0.3s;
        }

        .logo {
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--uitm-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo span {
            color: var(--uitm-purple);
        }

        .wallet-pill {
            background: var(--bg-neutral);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--uitm-green);
            transition: background 0.3s;
        }

        /* --- MAIN SCROLLABLE AREA --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 100px;
            /* Space for island nav */
            position: relative;
        }

        /* --- VIEWS (TABS) --- */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        /* --- CARDS --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            transition: background 0.3s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* --- MAP --- */
        .map-wrapper {
            height: 300px;
            /* Mobile height */
            background: var(--map-bg);
            border-radius: var(--radius-md);
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
            position: relative;
            transition: background 0.3s;
        }

        @media(min-width: 768px) {
            .map-wrapper {
                height: 400px;
            }
        }

        /* SVG Theme classes */
        .svg-campus {
            fill: var(--map-campus);
            stroke: var(--map-stroke);
            transition: fill 0.3s;
        }

        .svg-bg {
            fill: var(--map-bg);
            transition: fill 0.3s;
        }

        /* --- ETA CARDS --- */
        .eta-scroller {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
            /* Hide scrollbar */
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .eta-scroller::-webkit-scrollbar {
            display: none;
        }

        .eta-card {
            min-width: 140px;
            background: var(--bg-neutral);
            padding: 1rem;
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--uitm-green);
            flex-shrink: 0;
            transition: background 0.3s;
        }

        /* --- WALLET & QR --- */
        .wallet-card {
            background: linear-gradient(135deg, var(--uitm-green), #004d29);
            color: white;
            text-align: center;
        }

        .balance-display {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 1rem 0;
        }

        .qr-container {
            background: white;
            padding: 1rem;
            border-radius: var(--radius-sm);
            display: inline-block;
            margin: 1rem auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* --- BOTTOM NAVIGATION ISLAND --- */
        .nav-island-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 100;
            pointer-events: none;
            /* Let clicks pass through side areas */
        }

        .nav-island {
            background: var(--nav-bg);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow-float);
            display: flex;
            gap: 8px;
            pointer-events: auto;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: background 0.3s;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 20px;
            color: var(--text-sub);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 65px;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            fill: currentColor;
        }

        .nav-item.active {
            background: var(--uitm-purple);
            color: white;
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--uitm-gold);
            color: #4a3b00;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--uitm-gold);
            color: var(--text-dark);
        }

        .btn-danger {
            background: #ffecec;
            color: #d60000;
        }

        .btn-action {
            background: var(--surface);
            color: var(--uitm-green);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: none;
            align-items: flex-end;
            /* Bottom sheet on mobile */
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        @media(min-width: 768px) {
            .modal-overlay {
                align-items: center;
            }

            .modal {
                width: 400px;
                border-radius: var(--radius-lg) !important;
            }
        }

        .modal {
            background: var(--surface);
            width: 100%;
            padding: 1.5rem;
            border-top-left-radius: var(--radius-lg);
            border-top-right-radius: var(--radius-lg);
            animation: slideUp 0.3s ease;
            color: var(--text-dark);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* --- UTILITIES --- */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-admin {
            background: #ffecec;
            color: #d60000;
        }

        .badge-student {
            background: #e6f0e9;
            color: var(--uitm-green);
        }

        .hidden {
            display: none;
        }

        /* Text colors for schedule */
        table th,
        table td {
            color: var(--text-dark);
        }

        table thead {
            background: var(--bg-neutral) !important;
        }

        /* --- SVG MAP STYLES --- */
        .stop-dot {
            fill: white;
            stroke: var(--uitm-green);
            stroke-width: 3;
            r: 6;
            transition: r 0.2s;
        }

        .stop-dot:hover {
            r: 9;
        }

        .stop-text {
            font-size: 10px;
            fill: var(--text-sub);
            font-weight: bold;
        }

        .bus-marker {
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.3));
            transition: transform 0.1s linear;
        }

        .route-line {
            fill: none;
            stroke: var(--map-stroke);
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke 0.3s;
        }

        .route-active {
            fill: none;
            stroke: var(--uitm-green);
            stroke-width: 3;
            stroke-dasharray: 8, 4;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <header>
        <div class="logo">
            üöå UiTM <span>ShuttleGo</span>
        </div>
        <div class="wallet-pill">
            RM <span id="headerBalance">0.00</span>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main id="mainContent">

        <!-- === VIEW: TRACKER === -->
        <section id="view-tracker" class="view-section active">
            <div class="container">

                <!-- Map Card -->
                <div class="card" style="padding:0;">
                    <div class="map-wrapper">
                        <svg id="shuttleMap" viewBox="0 0 400 300" width="100%" height="100%"
                            preserveAspectRatio="xMidYMid slice">
                            <!-- Background/Campus -->
                            <rect class="svg-bg" width="100%" height="100%" />
                            <rect class="svg-campus" x="50" y="50" width="300" height="200" rx="20" stroke-width="1" />

                            <!-- Route -->
                            <path d="M 80 80 L 320 80 L 320 220 L 80 220 Z" class="route-line" />
                            <path d="M 80 80 L 320 80 L 320 220 L 80 220 Z" class="route-active" />

                            <!-- Stops -->
                            <circle cx="80" cy="80" class="stop-dot" />
                            <text x="60" y="65" class="stop-text">Seri Mulu</text>

                            <circle cx="320" cy="80" class="stop-dot" />
                            <text x="300" y="65" class="stop-text">Seri Gading</text>

                            <circle cx="320" cy="220" class="stop-dot" />
                            <text x="300" y="245" class="stop-text">UiTM KS2</text>

                            <circle cx="80" cy="220" class="stop-dot" />
                            <text x="60" y="245" class="stop-text">The SummerMall</text>

                            <!-- Bus -->
                            <g id="busMarker" class="bus-marker">
                                <rect x="-12" y="-8" width="24" height="16" rx="4" fill="#FFD100" stroke="#333"
                                    stroke-width="1.5" />
                                <rect x="-9" y="-5" width="18" height="6" fill="#333" />
                                <circle cx="-6" cy="8" r="2.5" fill="#333" />
                                <circle cx="6" cy="8" r="2.5" fill="#333" />
                            </g>
                        </svg>
                        <!-- Status Overlay -->
                        <div
                            style="position:absolute; top:10px; left:10px; background:rgba(255,255,255,0.9); padding:4px 10px; border-radius:12px; font-size:0.75rem; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                            <span style="color:green;">‚óè</span> Live: <span id="speedIndicator"
                                style="color:#333;">Normal Traffic</span>
                        </div>
                    </div>
                </div>

                <!-- Nearby ETAs -->
                <div>
                    <h3 class="card-title" style="margin-bottom:10px;">Arrival Times</h3>
                    <div class="eta-scroller" id="etaContainer">
                        <!-- Populated via JS -->
                    </div>
                </div>

                <!-- Quick Action -->
                <div class="card" onclick="app.navTo('pay')"
                    style="background: linear-gradient(to right, #eef2f3, #e0eafc); cursor:pointer;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="background:white; padding:10px; border-radius:50%;">üí≥</div>
                        <div style="color:#333;">
                            <div style="font-weight:bold;">Pay for Ride</div>
                            <div style="font-size:0.8rem; color:#666;">Tap to show QR Code</div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- === VIEW: SCHEDULE === -->
        <section id="view-schedule" class="view-section">
            <div class="container">
                <h2 class="card-title">Shuttle Timetable</h2>

                <div class="card">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                        <thead style="text-align:left; border-bottom:1px solid var(--map-stroke);">
                            <tr>
                                <th style="padding:10px; border-bottom:1px solid var(--map-stroke);">Stop</th>
                                <th style="padding:10px; border-bottom:1px solid var(--map-stroke);">Est. Arrival</th>
                            </tr>
                        </thead>
                        <tbody id="timetableBody">
                            <tr>
                                <td style="padding:10px; border-bottom:1px solid var(--map-stroke);">Kolej Seri Mulu
                                </td>
                                <td style="padding:10px; border-bottom:1px solid var(--map-stroke);">07:30 AM</td>
                            </tr>
                            <tr>
                                <td style="padding:10px; border-bottom:1px solid var(--map-stroke);">Kolej Gading
                                </td>
                                <td style="padding:10px; border-bottom:1px solid var(--map-stroke);">07:45 AM</td>
                            </tr>
                            <tr>
                                <td style="padding:10px; border-bottom:1px solid var(--map-stroke);">UiTM KS2
                                </td>
                                <td style="padding:10px; border-bottom:1px solid var(--map-stroke);">08:00 AM</td>
                            </tr>
                            <tr>
                                <td style="padding:10px;">The SummerMall</td>
                                <td style="padding:10px;">08:15 AM</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="card-title" style="margin-top:10px;">Announcements</h3>
                <div id="announcementFeed">
                    <!-- JS Populated -->
                </div>
            </div>
        </section>

        <!-- === VIEW: PAY (WALLET) === -->
        <section id="view-pay" class="view-section">
            <div class="container">

                <!-- Wallet Balance Card -->
                <div class="card wallet-card">
                    <div style="font-size:0.9rem; opacity:0.9;">My Balance</div>
                    <div class="balance-display">RM <span id="walletBalance">0.00</span></div>
                    <div style="font-size:0.8rem; margin-bottom:1rem;">Student ID: 2025123456</div>

                    <div class="qr-container">
                        <!-- Simple CSS/SVG QR Code Mockup -->
                        <svg viewBox="0 0 100 100" width="120" height="120">
                            <rect width="100" height="100" fill="white" />
                            <path d="M10 10h30v30h-30zM60 10h30v30h-30zM10 60h30v30h-30z" fill="black" />
                            <rect x="15" y="15" width="20" height="20" fill="white" />
                            <rect x="65" y="15" width="20" height="20" fill="white" />
                            <rect x="15" y="65" width="20" height="20" fill="white" />
                            <rect x="20" y="20" width="10" height="10" fill="black" />
                            <rect x="70" y="20" width="10" height="10" fill="black" />
                            <rect x="20" y="70" width="10" height="10" fill="black" />
                            <path d="M45 10h10v10h-10zM45 30h10v10h-10zM10 45h10v10h-10zM30 45h10v10h-10z" fill="black"
                                opacity="0.8" />
                            <rect x="50" y="50" width="40" height="40" rx="2" fill="#006837" opacity="0.1" />
                        </svg>
                        <div style="color:#333; font-size:0.7rem; margin-top:5px;">Scan to Ride</div>
                    </div>

                    <p id="paymentFeedback" style="height:20px; font-size:0.85rem; font-weight:bold; color:#fff;"></p>
                </div>

                <!-- Actions -->
                <div class="action-grid">
                    <button class="btn btn-action" onclick="app.openTopUpModal()">
                        <div style="font-size:1.5rem;">‚ûï</div>
                        <span>Top Up</span>
                    </button>
                    <button class="btn btn-action" onclick="app.simulateScan()">
                        <div style="font-size:1.5rem;">üöå</div>
                        <span>Pay RM 2.00</span>
                    </button>
                </div>

                <div class="card">
                    <div class="card-title">Transaction History</div>
                    <ul style="list-style:none; font-size:0.85rem; color:var(--text-sub);" id="transactionList">
                        <li
                            style="padding:8px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                            <span>Initial Bonus</span> <span style="color:green;">+ RM 5.00</span>
                        </li>
                    </ul>
                </div>

            </div>
        </section>

        <!-- === VIEW: PROFILE (SETTINGS/ADMIN) === -->
        <section id="view-profile" class="view-section">
            <div class="container">
                <div class="card" style="display:flex; align-items:center; gap:15px;">
                    <div
                        style="width:60px; height:60px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">
                        üë§</div>
                    <div>
                        <div class="card-title" style="margin:0;">Student Name</div>
                        <div style="color:var(--text-sub); font-size:0.9rem;">Faculty of Business Management</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">App Settings</div>
                    </div>

                    <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                        <span>Dark Mode</span>
                        <label class="switch" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="themeToggle" onchange="app.toggleTheme(this.checked)">
                            <span id="themeLabel"
                                style="font-weight:bold; color:var(--uitm-purple); font-size:0.9rem;">OFF</span>
                        </label>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--map-stroke); margin: 15px 0;">

                    <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                        <span>Driver / Admin Mode</span>
                        <label class="switch" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="adminToggle" onchange="app.toggleAdminMode(this.checked)">
                            <span id="adminLabel"
                                style="font-weight:bold; color:var(--uitm-purple); font-size:0.9rem;">OFF</span>
                        </label>
                    </div>
                </div>

                <!-- ADMIN CONSOLE (Hidden by default) -->
                <div id="adminConsole" class="card hidden"
                    style="border: 2px dashed var(--uitm-purple); background:var(--bg-neutral);">
                    <div class="card-title">üë®‚Äç‚úàÔ∏è Admin Controls</div>
                    <div style="display:grid; gap:10px;">
                        <button class="btn btn-danger" onclick="app.setTraffic(true)">‚ö†Ô∏è Report Traffic Jam (Slow
                            Bus)</button>
                        <button class="btn btn-outline" onclick="app.setTraffic(false)">‚ö° Clear Traffic Status</button>
                        <hr style="border:0; border-top:1px solid #eee;">
                        <input type="text" id="adminMsg" placeholder="Announcement text..."
                            style="padding:10px; border:1px solid #ddd; border-radius:8px; width:100%; background:var(--surface); color:var(--text-dark);">
                        <button class="btn btn-primary" onclick="app.postAnnouncement()">üì¢ Post Announcement</button>
                    </div>
                </div>

                <!-- CREDITS -->
                <div class="card" style="text-align: center; font-size: 0.9rem; color: var(--text-sub);">
                    Developed by <strong>Sylvester Ady Alichan</strong>
                </div>
            </div>
        </section>

    </main>

    <!-- NAVIGATION ISLAND -->
    <nav class="nav-island-container">
        <div class="nav-island">
            <div class="nav-item active" onclick="app.navTo('tracker')" id="nav-tracker">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                </svg>
                <span>Tracker</span>
            </div>
            <div class="nav-item" onclick="app.navTo('schedule')" id="nav-schedule">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
                </svg>
                <span>Schedule</span>
            </div>
            <div class="nav-item" onclick="app.navTo('pay')" id="nav-pay">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z" />
                </svg>
                <span>Pay</span>
            </div>
            <div class="nav-item" onclick="app.navTo('profile')" id="nav-profile">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
                <span>Profile</span>
            </div>
        </div>
    </nav>

    <!-- TOP UP MODAL -->
    <div id="topUpModal" class="modal-overlay" onclick="if(event.target===this) app.closeModal()">
        <div class="modal">
            <h3 style="margin-bottom:15px;">Top Up Balance</h3>
            <p style="margin-bottom:15px; font-size:0.9rem; color:var(--text-sub);">Select Payment Method:</p>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="btn btn-outline" onclick="app.processTopUp(10)">RM 10</button>
                <button class="btn btn-outline" onclick="app.processTopUp(20)">RM 20</button>
                <button class="btn btn-outline" onclick="app.processTopUp(50)">RM 50</button>
                <button class="btn btn-outline" style="border-style:dashed;">Custom</button>
            </div>

            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:5px; font-size:0.8rem;">Source</label>
                <select class="btn"
                    style="border:1px solid #ccc; padding:10px; background:var(--surface); color:var(--text-dark);">
                    <option>MAE / Maybank2u</option>
                    <option>Touch 'n Go eWallet</option>
                    <option>Boost</option>
                    <option>Sarawak Pay</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="app.processTopUp(10)">Confirm Top Up</button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const CONFIG = {
            routeLength: 1000,
            stops: [
                { id: 'mulu', name: 'Kolej Seri Mulu', x: 80, y: 80, p: 0 },
                { id: 'gading', name: 'Kolej Seri Gading', x: 320, y: 80, p: 240 },
                { id: 'UiTM', name: 'UiTM KS2', x: 320, y: 220, p: 380 },
                { id: 'Mall', name: 'The SummerMall', x: 80, y: 220, p: 620 }
            ]
        };

        const app = {
            // State
            balance: 5.00,
            busPos: 0,
            speed: 3,
            isTraffic: false,
            announcements: [],
            isDark: false,

            init: function () {
                this.loadData();
                this.renderBalance();
                this.renderAnnouncements();
                this.startSimulation();
                this.loadTheme();
            },

            // --- THEMING ---
            toggleTheme: function (isDark) {
                this.isDark = isDark;
                if (isDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.getElementById('themeLabel').innerText = "ON";
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    document.getElementById('themeLabel').innerText = "OFF";
                }
                localStorage.setItem('shuttle_theme', isDark ? 'dark' : 'light');
            },

            loadTheme: function () {
                const savedTheme = localStorage.getItem('shuttle_theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

                // Default to saved preference, or system preference if not saved
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.getElementById('themeToggle').checked = true;
                    this.toggleTheme(true);
                }
            },

            // --- NAVIGATION ---
            navTo: function (viewId) {
                // 1. Hide all views
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                // 2. Show target
                document.getElementById(`view-${viewId}`).classList.add('active');
                // 3. Update Bottom Nav Icons
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`nav-${viewId}`).classList.add('active');
            },

            // --- WALLET & PAYMENT ---
            renderBalance: function () {
                const val = this.balance.toFixed(2);
                document.getElementById('headerBalance').innerText = val;
                document.getElementById('walletBalance').innerText = val;
                localStorage.setItem('shuttle_balance', this.balance);
            },

            openTopUpModal: function () {
                document.getElementById('topUpModal').classList.add('open');
            },

            closeModal: function () {
                document.getElementById('topUpModal').classList.remove('open');
            },

            processTopUp: function (amount) {
                // Simulate banking delay
                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = "Processing...";

                setTimeout(() => {
                    this.balance += amount;
                    this.addTransaction(`Top Up via Online Banking`, `+ RM ${amount.toFixed(2)}`);
                    this.renderBalance();
                    this.closeModal();
                    btn.innerText = originalText;
                    alert(`Top up of RM ${amount} successful!`);
                }, 800);
            },

            simulateScan: function () {
                if (this.balance < 2.00) {
                    alert("Insufficient Balance! Please top up.");
                    return;
                }

                const feedback = document.getElementById('paymentFeedback');
                feedback.innerText = "Processing Payment...";

                setTimeout(() => {
                    this.balance -= 2.00;
                    this.renderBalance();
                    this.addTransaction("Shuttle Ride (Line A)", "- RM 2.00");
                    feedback.innerText = "‚úÖ Payment Successful!";
                    setTimeout(() => feedback.innerText = "", 3000);
                }, 1000);
            },

            addTransaction: function (desc, amountStr) {
                const list = document.getElementById('transactionList');
                const li = document.createElement('li');
                li.style.cssText = "padding:8px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; animation:fadeIn 0.5s;";
                li.innerHTML = `<span>${desc}</span> <span style="${amountStr.includes('+') ? 'color:green' : 'color:red'}">${amountStr}</span>`;
                list.prepend(li);
            },

            // --- SIMULATION ENGINE ---
            startSimulation: function () {
                setInterval(() => {
                    // Move bus
                    const currentSpeed = this.isTraffic ? 1 : this.speed;
                    this.busPos += currentSpeed;
                    if (this.busPos > CONFIG.routeLength) this.busPos = 0;

                    this.drawBus();

                    // Update ETA every second (~20 ticks)
                    if (Math.floor(this.busPos) % 20 === 0) this.updateETA();

                }, 50); // 20 updates per second
            },

            drawBus: function () {
                // Rectangular Logic: Top(0-240) -> Right(240-380) -> Bottom(380-620) -> Left(620-860)
                // Coordinates: TopL(80,80), TopR(320,80), BotR(320,220), BotL(80,220)

                let x, y;
                const p = this.busPos;

                if (p < 240) { // Top
                    x = 80 + p; y = 80;
                } else if (p < 380) { // Right
                    x = 320; y = 80 + (p - 240);
                } else if (p < 620) { // Bottom
                    x = 320 - (p - 380); y = 220;
                } else { // Left (Returning)
                    x = 80; y = 220 - (p - 620);
                    // Cap at start point
                    if (y < 80) y = 80;
                }

                const bus = document.getElementById('busMarker');
                bus.setAttribute('transform', `translate(${x}, ${y})`);
            },

            updateETA: function () {
                const container = document.getElementById('etaContainer');
                let html = '';

                CONFIG.stops.forEach(stop => {
                    let dist = stop.p - this.busPos;
                    if (dist < 0) dist += CONFIG.routeLength;

                    // Speed factor: 100 units = ~1 minute
                    const factor = this.isTraffic ? 20 : 10;
                    let mins = Math.ceil(dist / (this.speed * factor));

                    if (mins <= 0) mins = "Arriving";
                    else mins += " min";

                    html += `
                        <div class="eta-card">
                            <div style="font-size:1.5rem; font-weight:bold; color:var(--text-dark);">${mins}</div>
                            <div style="font-size:0.8rem; color:var(--text-sub);">${stop.name}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            },

            // --- ADMIN & DATA ---
            toggleAdminMode: function (isActive) {
                const consoleDiv = document.getElementById('adminConsole');
                const label = document.getElementById('adminLabel');

                if (isActive) {
                    consoleDiv.classList.remove('hidden');
                    label.innerText = "ON";
                    label.style.color = "red";
                } else {
                    consoleDiv.classList.add('hidden');
                    label.innerText = "OFF";
                    label.style.color = "var(--uitm-purple)";
                }
            },

            setTraffic: function (isTraffic) {
                this.isTraffic = isTraffic;
                const indicator = document.getElementById('speedIndicator');
                if (isTraffic) {
                    indicator.innerText = "Traffic Jam (Slow)";
                    indicator.style.color = "red";
                } else {
                    indicator.innerText = "Normal Traffic";
                    indicator.style.color = "#333";
                }
            },

            postAnnouncement: function () {
                const input = document.getElementById('adminMsg');
                if (!input.value) return;

                this.announcements.unshift({ text: input.value, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
                this.renderAnnouncements();
                input.value = "";
                alert("Announcement Posted");
            },

            renderAnnouncements: function () {
                const container = document.getElementById('announcementFeed');
                if (this.announcements.length === 0) {
                    container.innerHTML = `<div class="card" style="color:var(--text-sub); text-align:center;">No recent announcements.</div>`;
                    return;
                }
                let html = '';
                this.announcements.forEach(a => {
                    html += `
                    <div class="card" style="margin-top:10px; border-left:4px solid #FFD100;">
                        <div style="font-size:0.75rem; color:var(--text-sub);">Admin ‚Ä¢ ${a.time}</div>
                        <div style="color:var(--text-dark);">${a.text}</div>
                    </div>`;
                });
                container.innerHTML = html;
            },

            loadData: function () {
                const bal = localStorage.getItem('shuttle_balance');
                if (bal) this.balance = parseFloat(bal);
            }
        };

        // Init
        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>

</html>